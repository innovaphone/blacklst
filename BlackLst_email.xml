<?xml version="1.0" encoding="utf-8" ?>
<voicemail xmlns="http://www.innovaphone.com/xsd/voicemail6.xsd">
    <function define="CheckTo">
        <assign out="$i" value="1"/>
        <assign out="$c" value=""/>
        <return notcond="$to"/>
        <index value="$to" pos="$i" size="1" out="$c"/>
        <lib-strlen string="$c" out="$len-c" />
        <while cond="$len-c">
            <switch var="$c">
                <case equal="@">
                    <return/>          <!-- '@' found, smells like an email address -->
                </case>
            </switch>

            <add value="$i" value2="1" out="$i"/>
            <assign out="$c" value=""/>
            <index value="$to" pos="$i" size="1" out="$c"/>
            <lib-strlen string="$c" out="$len-c" />
        </while>
        <assign out="$to" value=""/>   <!-- doesn't seem to be an email address -->
    </function>
	
	<function define="QueryEmail">
	
		<store-cookie root="" name="Email.txt" out="$custom_email"/> <!-- retrieve custom email from Email.txt -->
		<switch var="$custom_email">
			<case not-equal="">
				<assign out="$to" value="$custom_email"/>
				<call name="CheckTo"/>
			</case>
			<case equal="">
				<pbx-query-obj name="$cn_obj" type="email" out="$to"/>
				<call name="CheckTo"/>
			</case>
		</switch>
	</function>
	
	<function define="CreateNumbersList">
		<store-get-msgcount root="BL_Numbers" out-count="$number_count"/>
		<assign out="$numbers_list" value=""/>
		<assign out="$numbers_line" value=""/>
		<assign out="$new_line" value="&#x0d;&#x0a;" />
		
		<store-getnext root="BL_Numbers" out-handle="$handle" out-url="$BL_number"/>
			<while cond="$BL_number">
				<store-split url="$BL_number" out-file="$BL_number" />
				<lib-strcat out-string="$numbers_line" string="$BL_number" string2="$new_line"/>
				<lib-strcat out-string="$numbers_list" string="$numbers_list" string2="$numbers_line"/>
				<store-getnext root="BL_Numbers" handle="$handle" out-url="$BL_number"/>
			</while>

	</function>

	
    <function define="Main">
                <call name="QueryEmail" />
				<call name="CreateNumbersList" />
                <if cond="$to">
					
					<lib-strcat out-string="$BL_subject" string="$number_count" string2=" numbers in your blacklist"/>
                    <assign out="$from" value="$to"/>    <!--from email = to address by default-->
                    <assign out="$subject" value="$BL_subject"/>
                    <assign out="$body" value="$numbers_list"/> <!-- lista di numeri: body=name:%0D%0Aemail: -->
                    <assign out="$server" value=""/>     <!--optional, outgoing smtp server-->
                    <assign out="$user" value=""/>       <!--optional, authentication info-->
                    <assign out="$password" value=""/>   <!--optional, authentication info-->

                    <assign out="$file" value=""/>       <!-- <assign out="$file" value="$vm"/> experimental -->

                        <!--Now send the email-->
					<assign out="$exec-err" value="0"/>
                    <exec url="mailto:$to?from=$to&amp;subject=$subject&amp;body=$body&amp;srv=$server&amp;pwd=$password&amp;file=$file" out-error="$exec-err"/>
					<if cond="$exec-err">
						<!-- 2nd try -->
						<exec url="mailto:$to?from=$to&amp;subject=$subject&amp;body=$body&amp;srv=$server&amp;pwd=$password&amp;file=$file"/>
					</if>
                </if>
    </function>
</voicemail>

<!-- Black List Service XML Script For Incoming Calls wiki-src/xml/BlackLst 1,0,17,0 (C) innovaphone AG 2010-2017 -->
